# 钱包

## 资料
- [go-wallet-sdk](https://github.com/okx/go-wallet-sdk)
- [wallet-chain-node](https://github.com/dapplink-labs/wallet-chain-node)
- [btcwallet](https://github.com/btcsuite/btcwallet)
- [go-ethereum-hdwallet](https://github.com/miguelmota/go-ethereum-hdwallet)
- [理解开发HD 钱包涉及的 BIP32、BIP44、BIP39](https://learnblockchain.cn/2018/09/28/hdwallet/)
- [blockchain](https://www.blockchain.com/explorer)

## 概念
私钥和地址的关系：私钥通过椭圆曲线生成公钥， 公钥通过哈希函数生成地址，这两个过程都是单向的。
数字钱包实际是一个管理私钥（生成、存储、签名）的工具，注意钱包并不保存资产，资产是在链上的。

## 普通分类
- 本地钱包：是把私钥保存在本地计算机硬盘上的钱包软件，如Electrum；
- 手机钱包：和本地钱包类似，但可以直接在手机上运行，如Bitpay；
- 在线钱包：是把私钥委托给第三方在线服务商保存；
- 纸钱包：是指把私钥打印出来保存在纸上；
- 脑钱包：是指把私钥记在自己脑袋里。

## 分类

- 中心化钱包：钱包私钥一般管理在中心化服务器上，代表项目为交易所钱包；例如 Binance 交易所钱包，OKX 交易所钱包和 Bybit 交易所钱包等。
- 去中心化钱包(确定性分层钱包)：钱包私钥一般管理在用户的设备上，代表项目为 TP, ImToken, MetaMask 等；
  - 根据某种确定性算法，只需要管理一个根私钥，即可实时计算所有“子私钥”的管理方式，称为HD钱包。
  - HD钱包还有一种硬化的衍生计算方式（Hardened Derivation），它通过算法“切断”了母扩展私钥和子扩展私钥的反向推导。HD规范把索引0～231作为普通衍生索引，而索引231～232作为硬化衍生索引，硬化衍生索引通常记作0'、1'、2'……，即索引0'=231，1'=231+1，2'=231+2，以此类推。
- 硬件钱包：钱包私钥管理在离线的硬件设备上，代表项目 ledger, onekey 等。
- 交易所 Web3 钱包：一般的交易所 Web3 钱包集成了，中心化钱包，去中心化钱包(确定性分层钱包)和硬件钱包的功能。
- 托管钱包：一般为 MPC 算法，每个节点有一个密钥片，网络中没有完整的私钥出现过, N-M 的签名方式，总节点为 N 个，M 个节点签名交易即有效。
- 多签钱包：EVM 链一般使用 gnosis safe 多签，其他使用传统密码学方式多签
- 社交恢复钱包: 密钥分片备份和守护者恢复
- EVM 链 AA 钱包：ERC4337 协议独有特性

## BIP
> [提案](https://github.com/satoshilabs/slips/)
-  BIP-39:助记词
-  BIP-32:HD[Hierarchical Deterministic Wallets]钱包(为了避免管理一堆私钥的麻烦提出的分层推导方案)
-  BIP-44:给BIP32的分层路径定义规范,同时增加了对多币种的支持。
  - `m / purpose' / coin' / account' / change / address_index`
  - Coin type:币种，0代表比特币，1代表比特币测试链，60代表以太坊
  - Account:代表这个币的账户索引，从0开始
  - Change:常量0用于外部(收款地址)，常量1用于内部（也称为找零地址）。外部用于在钱包外可见的地址（例如，用于接收付款）。内部链用于在钱包外部不可见的地址，用于返回交易变更。 (所以一般使用0)
  - address_index:这就是地址索引，从0开始，代表生成第几个地址，官方建议，每个account下的address_index不要超过20
  - [测试地址](https://chaintool.tech/generateWallet/btcWallet)
  - [测试地址](https://iancoleman.io/bip39/#english)
- BIP86:专门为比特币生成单密钥 Taproot 地址设计，简化了路径和使用场景。
- EIP4337:账户抽象。

## [Rosetta Api](./Rosetta.md) 
为区块链和钱包提供一个统一的接口标准


## 助记词(Mnemonic Phrase)

### 助记词原理
1. 随机熵生成：熵长度有 128 位（12 个助记词）和 256 位（24 个助记词），并且是 32 的倍数。
1. 计算校验和：对熵进行 SHA-256 哈希计算，并取哈希值的前几位作为校验和。校验和的长度取决于熵的长度。例如，128 位熵需要 4 位校验和（因为 128 / 32 = 4），256 位熵需要 8 位校验和。
1. 组合熵和校验：将校验和附加到熵的末尾，形成一个新的二进制序列。这个序列的总长度为 (熵的长度 + 校验和的长度)。
1. 分割为助记词索引：将组合后的二进制序列分割成每组 11 位的片段，每个片段转换为一个数字，这个数字作为助记词列表中的索引。
1. 映射为助记词：使用这些索引从预定义的 2048 个助记词列表（BIP-39 词库）中提取相应的助记词。这些助记词就是最终的助记词短语。


## 多重签名钱包
- 为了避免一个私钥的丢失导致地址的资金丢失，引入了多重签名机制，可以实现分散风险的功能。
- 基于有限单群的 Schnorr 多重数字签名算法通过结合有限单群的复杂结构和多重签名机制，提供了强大的安全性和高效性，适用于现代分布式系统和密码学应用。
- BLS (Boneh-Lynn-Shacham) 签名算法是一种基于双线性配对（bilinear pairing）和椭圆曲线密码学的数字签名算法.
  - 简洁性：BLS签名非常简洁，签名的大小固定且较小，只有一个群元素。 
  - 效率：签名生成和验证的计算量相对较小，尤其是在签名长度较短的情况下。
  - 聚合签名：BLS签名具有天然的签名聚合（aggregate signature）特性，多个签名可以被聚合成一个签名，从而减少存储和传输的开销。这在区块链和分布式系统中尤为有用。
  - 多重签名：BLS也支持多重签名（multi-signature），多个用户可以共同签署同一消息，生成一个联合签名。


## 中心化钱包开发 
1. 离线地址生成
   1. 调度签名机生成密钥对，签名机吐出公钥
   2. 使用公钥匙导出地址
2. 充值逻辑
   1. 获得最新块高；更新到数据库
   2. 从数据库中获取上次解析交易的块高做为起始块高，最新块高为截止块高，如果数据库中没有记录，说明需要从头开始扫，起始块高为 0
   3. 解析区块里面的交易，to 地址是系统内部的用户地址，说明用户充值，更新交易到数据库中，将交易的状态设置为待确认
   4. 所在块的交易过了确认位，将交易状态更新位充值成功并通知业务层
   5. 解析到的充值交易需要在钱包的数据库里面维护
      1. BTC维护:UTXO
      2. ETH维护 nonce, 当然也可以不维护，签名的时候去链上获取
3. 提现逻辑
   1. 获取离线签名需要的参数，给合适的手续费
   2. 构建未签名的交易消息摘要，将消息摘要递给签名机签名
   3. 构建完整的交易并进行序列化
   4. 发送交易到区块链网络
   5. 扫链获取到交易之后更新交易状态并上报业务层
4. 归集逻辑
   1. 将用户地址上的资金转到归集地址，签名流程类似提现
   2. 发送交易到区块链网络
   3. 扫链获取到交易之后更新交易状态
5. 转冷逻辑
   1. 将热钱包地址上的资金转到冷钱包地址，签名流程类似提现
   2. 发送交易到区块链网络
   3. 扫链获取到交易之后更新交易状态
6. 冷转热逻辑
   1. 手动操作转账到热钱包地址
   2. 扫链获取到交易之后更新交易状态

## HD 钱包和交易所钱包不同之处有以下几点
1. 密钥管理方式不同
   1. HD 钱包私钥在本地设备，私钥用户自己控制
   2. 交易所钱包中心化服务器(CloadHSM, TEE 等)，私钥项目方控制
2. 资金存在方式不同
   1. HD 资金在用户钱包地址
   2. 交易所钱包资金在交易所热钱包或者冷钱包里面，用户提现的时候从交易所热钱包提取
3. 业务逻辑不一致
   1. 中心化钱包：实时不断扫链更新交易数据和状态
   2. HD 钱包：根据用户的操作通过请求接口实现业务逻辑


## Staking 功能
- 持有者通过将其加密货币锁定在特定的区块链网络中，从而获得奖励。
- ETH2.0 质押产品 LSD 开发的复杂度是比较高的 ，但是对于钱包接入来说，只需要对接 LSD 合约就行。
- Solana 和 Tezos 质押在钱包开发中也比较简单，其他链的开发也和他们大同小异。




## 币种钱包

- [BTC](./coin/btc.md)

